<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Rozha+One&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>

        <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/n8SrLzG.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://i.imgur.com/lG8hWO7.png">

        <title>[games]</title>

        <style>
            .rozha-one-regular {
                font-family: "Rozha One", serif;
                font-weight: 400;
                font-style: normal;
            }
            
            .image {
                position: relative;
                overflow: hidden;
                text-align: right;
                height: 200px;
                z-index: 1;
            }

            .image:hover {
                z-index: 2;
            }
            
            .image span {
                position: absolute;
                right: 0;
                bottom: 0;
                background-color: white;
                text-decoration: none;
                outline: none;
                color: black;
                padding: 6px 12px;
            }

            .image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
        </style>
    </head>
    <body class="flex flex-column justify-center items-center mb5">
        <div class="mv4 pv1 w-80">
            <div class="f5 bg-near-black white tl">
                <p class="ma0 mt2 ml2 pv1">&nbsp;</p>
            </div>
            <div class="rozha-one-regular measure f-headline tr">
                <p class="mh0 mv3">[games]</p>
            </div>
            <div class="f5 bg-near-black white tr avenir">
                <p class="ma0 mt2 mr2 pv1"><span class="entries-count"></span> as selected by <a class="link pointer usn light-blue dim" href="https://twitter.com/RaycatWhoDat">RaycatWhoDat</a></p>
            </div>
        </div>

        <div class="mb2 pv2 w-80 bg-light-gray tc">
            <p class="f4 i avenir">"Sometimes you see a game for a few seconds and you just know, man."</p>
        </div>
        
        <div class="pv2 w-80 avenir lh-copy">
            <p><span class="b">[games]</span> is my response to the mountain of "Top X Y games" lists on the Internet. There's no ranking to these games. The only criterion for inclusion on this list is if the game catches my eye. Maybe one will catch yours?</p>
        </div>

        <div class="w-50 mb4 pa1 bg-near-black white avenir tc lh-solid">
            <span class="sort added bg-white near-black pa2 usn pointer">sort by added</span> <span class="sort name-asc ml2 pa2 usn pointer">sort by name (ascending)</span>
        </div>

        <div class="games w-80 justify-center items-center"></div>
        
        <div class="mv4 pv2 w-80 bg-near-black near-white tc">
            <p class="f4 i avernir">"As a <a class="link pointer usn white dim" href="https://twitch.tv/DNOpls">wise man</a> once said... 'so many game, no many time'."</p>
        </div>

        <script>
         (async (document, window) => {
             let lazyImageObserver;
             const isIntersectionObserverAvailable = 'IntersectionObserver' in window;

             if (isIntersectionObserverAvailable) {
                 lazyImageObserver = new IntersectionObserver((entries, observer) => {
                     entries.forEach(entry => {
                         if (!entry.isIntersecting) return;
                         let lazyImage = entry.target;
                         lazyImage.src = lazyImage.dataset.src;
                         localStorage.setItem(lazyImage.src, `${Date.now()}`);
                         observer.unobserve(lazyImage);
                     });
                 }, { threshold: 0.01 });
             }
             
             const rawGamesResponse = await fetch('https://raymperry.github.io/games-list/games.csv');
             const gamesResponse = await rawGamesResponse.text();
             const GAMES = gamesResponse.trim().split('\n').slice(1);

             const entriesCount = document.querySelector('.entries-count');
             entriesCount.textContent = `${GAMES.length} games`;

             const rebuildList = listOfGames => {
                 const gamesContainer = document.querySelector('.games');
                 const allGames = document.createDocumentFragment();

                 const now = Date.now();
                 
                 listOfGames.forEach((entry, index) => {
                     const [_, name, image, url] = /"(.+)","(.+)","(.*)"/g.exec(entry) ?? [];
                     
                     if (!name) return;

                     const entryElem = document.createElement('div');
                     entryElem.classList.add('image', 'w-third', 'ba', 'bw1', 'b--near-black', 'bg-light-gray', 'usn');
                     if (index % 3 !== 2) entryElem.classList.add('mr2');

                     const imageElem = document.createElement('img');
                     imageElem.alt = name;

                     if (isIntersectionObserverAvailable && (!localStorage.getItem(image) || (now - Number(localStorage.getItem(image)) > 1000 * 60 * 60 * 24))) {
                         imageElem.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdj+P///38ACfsD/QVDRcoAAAAASUVORK5CYII='
                         imageElem.dataset.src = image;
                         lazyImageObserver?.observe(imageElem);
                     } else {
                         imageElem.src = image;
                     }

                     entryElem.appendChild(imageElem);
                     
                     const textElem = document.createElement('span');
                     textElem.textContent = name;
                     entryElem.appendChild(textElem);

                     if (url) {
                         entryElem.classList.add('dim', 'pointer');

                         entryElem.addEventListener('click', () => {
                             window.open(url, '_blank').focus();
                         });
                     } 

                     if (index % 3) {
                         const rowElem = allGames.querySelector('.row:last-child');
                         rowElem.appendChild(entryElem);
                         allGames.appendChild(rowElem);
                     } else {
                         const rowElem = document.createElement('div');
                         rowElem.classList.add('row', 'mb2', 'flex');
                         rowElem.appendChild(entryElem);
                         allGames.appendChild(rowElem);
                     }
                 });

                 if (gamesContainer.childElementCount === 0) {
                     gamesContainer.appendChild(allGames);
                 } else {
                     gamesContainer.replaceChildren(allGames);
                 }
             };

             rebuildList(GAMES);

             const sortGames = event => {
                 if (event.target.classList.contains('bg-white')) return;
                 
                 const allSortElems = document.querySelectorAll('.sort');
                 allSortElems.forEach(elem => {
                     elem.classList.remove('bg-white', 'near-black');
                 });
                 event.target.classList.add('bg-white', 'near-black');

                 let listOfGames = GAMES;

                 if (event.target.classList.contains('name-asc')) {
                     rebuildList(listOfGames.toSorted((a, b) => a.charCodeAt(1) - b.charCodeAt(1)));
                 } else {
                     rebuildList(listOfGames);
                 }
             };
             
             const sortByAddedElem = document.querySelector('.sort.added');
             sortByAddedElem.addEventListener('click', sortGames);
             const sortByNameAscElem = document.querySelector('.sort.name-asc');
             sortByNameAscElem.addEventListener('click', sortGames);

         })(document, window);
        </script>
    </body>
</html>
